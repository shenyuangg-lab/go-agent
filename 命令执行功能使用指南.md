# 命令执行功能使用指南

## 功能概述

新增的命令执行功能允许 Go Agent 根据监控平台返回的 `itemKey`（如 `system.cpu.util`、`mysql.ping` 等）自动执行对应的系统命令、脚本或数据库查询，并将执行结果上报到监控中心。

## 核心特性

✅ **自动命令映射** - 根据配置文件将监控项Key映射到具体命令
✅ **多种命令类型** - 支持PowerShell、CMD、MySQL查询、脚本文件等
✅ **并发控制** - 可配置的并发执行限制和超时控制
✅ **重试机制** - 支持失败重试和错误处理
✅ **实时上报** - 执行结果自动上报到监控中心

## 文件结构

```
configs/
└── command_mapping.yaml    # 命令映射配置文件
pkg/collector/
└── command.go             # 命令执行采集器实现
```

## 配置文件详解

### 命令映射配置 (`configs/command_mapping.yaml`)

```yaml
commands:
  # 系统指标命令
  "system.cpu.util":
    type: "powershell"
    command: "Get-WmiObject -Class Win32_Processor | Select-Object -ExpandProperty LoadPercentage"
    timeout: 10
    description: "CPU使用率"
    
  # MySQL数据库查询
  "mysql.ping":
    type: "mysql"
    command: "SELECT 1"
    host: "localhost"
    port: 3306
    username: "root"
    password: "password"
    database: "mysql"
    timeout: 30
    description: "MySQL连接检查"
    
  # 自定义脚本
  "custom.script.example":
    type: "script"
    command: "./scripts/custom_monitor.bat"
    timeout: 60
    description: "自定义监控脚本"

# 全局配置
settings:
  default_timeout: 30
  enabled: true
  retry_count: 2
  retry_interval: 5
  max_concurrent: 10
```

### 支持的命令类型

| 类型 | 说明 | 参数 |
|------|------|------|
| `powershell` | PowerShell命令 | `command`, `timeout` |
| `cmd` | CMD命令 | `command`, `timeout` |
| `mysql` | MySQL数据库查询 | `command`, `host`, `port`, `username`, `password`, `database`, `timeout` |
| `script` | 脚本文件执行 | `command` (脚本路径), `timeout` |

## 工作流程

1. **初始化** - 代理启动时加载命令映射配置
2. **监控项同步** - 从监控平台获取需要采集的监控项列表
3. **命令执行** - 根据监控项的 `itemKey` 查找对应命令并执行
4. **结果处理** - 将命令执行结果转换为数字或字符串
5. **数据上报** - 通过指标发送器将结果上报到监控平台

## 实际使用示例

### 1. 系统监控示例

监控平台配置了以下监控项：
- Item ID: 1001, Item Key: `system.cpu.util`
- Item ID: 1002, Item Key: `vm.memory.size[total]`

代理会自动：
1. 执行 PowerShell 命令获取 CPU 使用率
2. 执行 WMI 查询获取内存总量
3. 将结果上报给对应的 Item ID

### 2. MySQL监控示例

配置文件中的 MySQL 命令：
```yaml
"mysql.connected_count":
  type: "mysql"
  command: "SHOW STATUS LIKE 'Threads_connected'"
  host: "localhost"
  port: 3306
  username: "monitor"
  password: "monitor123"
  database: "mysql"
  timeout: 30
  description: "MySQL连接数"
```

### 3. 自定义脚本示例

创建脚本文件 `scripts/disk_usage.bat`:
```batch
@echo off
for /f "tokens=3" %%a in ('dir c:\ ^| find "bytes free"') do echo %%a
```

配置文件中添加：
```yaml
"custom.disk.free":
  type: "script"
  command: "scripts/disk_usage.bat"
  timeout: 30
  description: "C盘可用空间"
```

## 使用方法

### 1. 配置命令映射

编辑 `configs/command_mapping.yaml` 文件，添加需要的命令映射。

### 2. Windows平台运行

#### 方法1: 直接运行
```cmd
# 构建程序
go build -o go-agent.exe cmd/agent/main.go

# 使用默认配置运行
go-agent.exe

# 使用指定配置文件运行
go-agent.exe -c configs/config.yaml

# 详细日志模式运行
go-agent.exe -v
```

#### 方法2: 使用批处理脚本
```cmd
# 构建
build.bat

# 启动
start.bat
```

#### 方法3: 安装为Windows服务
```cmd
# 安装服务
install_service.bat

# 启动服务
net start go-agent

# 查看服务状态
sc query go-agent

# 卸载服务
uninstall_service.bat
```

#### 方法4: PowerShell脚本
```powershell
# 使用PowerShell脚本构建
.\build.ps1

# 模拟监控演示
.\simulate_monitor.ps1
```

### 3. CentOS/Linux平台运行

#### 方法1: 直接运行
```bash
# 构建程序 (支持交叉编译)
GOOS=linux GOARCH=amd64 go build -o go-agent cmd/agent/main.go

# 复制到CentOS服务器
scp go-agent configs/config.yaml user@centos-server:/opt/go-agent/

# 在CentOS上运行
cd /opt/go-agent
chmod +x go-agent
./go-agent

# 指定配置文件
./go-agent -c config.yaml

# 详细日志运行
./go-agent -v
```

#### 方法2: 作为systemd服务运行
```bash
# 创建服务文件
sudo vi /etc/systemd/system/go-agent.service
```

服务文件内容：
```ini
[Unit]
Description=Go Agent Monitor
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/go-agent
ExecStart=/opt/go-agent/go-agent -c /opt/go-agent/config.yaml
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 设置开机启动
sudo systemctl enable go-agent

# 启动服务
sudo systemctl start go-agent

# 查看服务状态
sudo systemctl status go-agent

# 查看实时日志
sudo journalctl -u go-agent -f

# 停止服务
sudo systemctl stop go-agent

# 重启服务
sudo systemctl restart go-agent
```

#### 方法3: 后台运行
```bash
# 后台运行
nohup ./go-agent -c config.yaml > go-agent.log 2>&1 &

# 查看进程
ps aux | grep go-agent

# 查看日志
tail -f go-agent.log

# 停止程序
kill $(ps aux | grep 'go-agent' | grep -v grep | awk '{print $2}')
```

### 4. 检查运行状态

#### Windows平台
```cmd
# 查看进程
tasklist | findstr go-agent

# 查看端口占用
netstat -ano | findstr :8081

# 查看服务状态
sc query go-agent
```

#### Linux平台  
```bash
# 查看进程
ps aux | grep go-agent

# 查看端口占用
netstat -tulpn | grep go-agent

# 测试API连通性
curl -I http://all.roywise.cn:8081/api

# 查看系统日志
journalctl -u go-agent -f
```

### 5. 配置说明

当前配置会：
- 启用系统指标采集（CPU、内存、磁盘、网络）
- 30秒采集间隔
- 通过HTTP上报到监控平台
- 启用设备监控API，自动注册和心跳

### 6. 查看执行日志

代理会输出详细的执行日志：
```
INFO[2025-09-05T22:07:47+08:00] 命令映射配置加载完成 command_count=13 enabled=true
INFO[2025-09-05T22:07:47+08:00] 命令执行采集器初始化完成
INFO[2025-09-05T22:07:48+08:00] 已更新命令执行采集器的监控项映射: 5 项
```

## 性能和安全考虑

### 性能优化
- **并发控制**: 通过 `max_concurrent` 限制同时执行的命令数量
- **超时控制**: 每个命令都有独立的超时设置
- **重试机制**: 失败的命令会根据配置进行重试

### 安全考虑
- **权限控制**: 命令以当前用户权限执行
- **输入验证**: 所有命令参数都经过验证
- **错误处理**: 异常情况会被妥善处理并记录日志

## 故障排查

### 常见问题

1. **命令执行超时**
   - 检查 `timeout` 配置是否合理
   - 确认命令本身执行时间

2. **MySQL连接失败**
   - 验证数据库连接参数
   - 检查网络连接和权限

3. **脚本执行权限问题**
   - 确保脚本文件有执行权限
   - 检查脚本路径是否正确

### 调试技巧

1. **启用详细日志**
   ```yaml
   log:
     level: "debug"
   ```

2. **查看命令列表**
   - 在代理启动日志中查看已加载的命令数量
   - 检查命令映射是否正确加载

## 扩展开发

### 添加新的命令类型

1. 在 `pkg/collector/command.go` 中添加新的执行方法
2. 在 `executeCommand` 方法中添加对应的 case 分支
3. 更新配置文件格式说明

### 自定义结果处理

可以修改 `processValue` 方法来实现特定的结果处理逻辑，例如：
- 复杂数据结构的解析
- 多行输出的处理  
- 特定格式的转换

## 总结

命令执行功能极大地扩展了 Go Agent 的监控能力，让您可以：

- 🚀 **快速扩展**: 通过配置文件快速添加新的监控命令
- 🔧 **灵活配置**: 支持多种命令类型和参数配置
- 📊 **实时监控**: 自动执行命令并上报结果
- 🛡️ **安全可靠**: 完善的错误处理和重试机制

现在您可以根据实际需求修改 `configs/command_mapping.yaml` 文件，添加您需要的监控命令，然后启动代理程序开始使用这个强大的功能！